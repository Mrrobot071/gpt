# Bot WhatsApp com Gemini AI - Guia Completo

## üìã Pr√©-requisitos

- Node.js (vers√£o 16 ou superior)
- npm ou yarn
- Conta Google para acessar a API do Gemini
- Telefone para vincular ao WhatsApp

## üöÄ Passo 1: Configura√ß√£o Inicial

### 1.1 - Criar pasta do projeto
```bash
mkdir whatsapp-gemini-bot
cd whatsapp-gemini-bot
npm init -y
```

### 1.2 - Instalar depend√™ncias
```bash
npm install whatsapp-web.js @google/generative-ai qrcode-terminal dotenv
```

### 1.3 - Estrutura do projeto
```
whatsapp-gemini-bot/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ bot.js
‚îÇ   ‚îú‚îÄ‚îÄ gemini.js
‚îÇ   ‚îî‚îÄ‚îÄ prompts.js
‚îú‚îÄ‚îÄ .env
‚îú‚îÄ‚îÄ .gitignore
‚îî‚îÄ‚îÄ package.json
```

## üîë Passo 2: Configurar API do Gemini

### 2.1 - Obter chave da API
1. Acesse: https://makersuite.google.com/app/apikey
2. Clique em "Create API Key"
3. Copie a chave gerada

### 2.2 - Criar arquivo .env
```env
GEMINI_API_KEY=sua_chave_aqui
```
AIzaSyDhJo12ftwCeMzVI-30smS-aqWqn4ZChhU

### 2.3 - Criar .gitignore
```gitignore
node_modules/
.env
.wwebjs_auth/
.wwebjs_cache/
```

## üí° Passo 3: Configurar Prompts Personalizados

### src/prompts.js
```javascript
const prompts = {
  // Prompt padr√£o do bot
  default: `Voc√™ √© um assistente inteligente do WhatsApp chamado GeminiBot. 
Caracter√≠sticas:
- Seja amig√°vel e prestativo
- Responda de forma clara e objetiva
- Use emojis quando apropriado
- Mantenha respostas concisas para WhatsApp
- Se apresente apenas quando cumprimentado pela primeira vez`,

  // Prompt para suporte t√©cnico
  technical: `Voc√™ √© um especialista em suporte t√©cnico.
- Forne√ßa solu√ß√µes pr√°ticas e detalhadas
- Use linguagem t√©cnica quando necess√°rio
- Sempre pergunte sobre o sistema operacional e vers√µes
- Ofere√ßa m√∫ltiplas solu√ß√µes quando poss√≠vel`,

  // Prompt para educa√ß√£o
  educational: `Voc√™ √© um tutor educacional.
- Explique conceitos de forma did√°tica
- Use exemplos pr√°ticos
- Adapte a linguagem ao n√≠vel do estudante
- Fa√ßa perguntas para verificar o entendimento`,

  // Prompt para vendas
  sales: `Voc√™ √© um consultor de vendas profissional.
- Seja persuasivo mas n√£o insistente
- Identifique necessidades do cliente
- Apresente benef√≠cios claros
- Conduza para o fechamento da venda`,

  // Prompt criativo
  creative: `Voc√™ √© um assistente criativo.
- Pense fora da caixa
- Ofere√ßa ideias inovadoras
- Use linguagem inspiradora
- Estimule a criatividade do usu√°rio`
};

// Fun√ß√£o para obter prompt baseado em palavra-chave
function getPromptByKeyword(message) {
  const msg = message.toLowerCase();
  
  if (msg.includes('t√©cnico') || msg.includes('problema') || msg.includes('erro')) {
    return prompts.technical;
  }
  
  if (msg.includes('aprenda') || msg.includes('estudo') || msg.includes('explicar')) {
    return prompts.educational;
  }
  
  if (msg.includes('venda') || msg.includes('produto') || msg.includes('comprar')) {
    return prompts.sales;
  }
  
  if (msg.includes('criativo') || msg.includes('ideia') || msg.includes('inventar')) {
    return prompts.creative;
  }
  
  return prompts.default;
}

// Comandos especiais para trocar de prompt
const commands = {
  '/prompt_tecnico': prompts.technical,
  '/prompt_educacional': prompts.educational,
  '/prompt_vendas': prompts.sales,
  '/prompt_criativo': prompts.creative,
  '/prompt_padrao': prompts.default
};

module.exports = {
  prompts,
  getPromptByKeyword,
  commands
};
```

## ü§ñ Passo 4: Configurar Integra√ß√£o com Gemini

### src/gemini.js
```javascript
const { GoogleGenerativeAI } = require('@google/generative-ai');
require('dotenv').config();

class GeminiService {
  constructor() {
    this.genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
    this.model = this.genAI.getGenerativeModel({ model: "gemini-pro" });
    this.conversations = new Map(); // Armazena hist√≥rico por usu√°rio
  }

  // Gerar resposta com contexto personalizado
  async generateResponse(userId, message, customPrompt = null) {
    try {
      // Recupera ou cria hist√≥rico da conversa
      let conversation = this.conversations.get(userId) || [];
      
      // Adiciona prompt personalizado se fornecido
      if (customPrompt) {
        conversation = [{
          role: "user",
          parts: [{ text: customPrompt }]
        }];
      }

      // Adiciona mensagem atual
      conversation.push({
        role: "user",
        parts: [{ text: message }]
      });

      // Limita hist√≥rico a 10 mensagens para economizar tokens
      if (conversation.length > 10) {
        conversation = conversation.slice(-10);
      }

      // Gera resposta
      const chat = this.model.startChat({
        history: conversation.slice(0, -1),
        generationConfig: {
          maxOutputTokens: 1000,
          temperature: 0.7,
        },
      });

      const result = await chat.sendMessage(message);
      const response = result.response.text();

      // Adiciona resposta ao hist√≥rico
      conversation.push({
        role: "model",
        parts: [{ text: response }]
      });

      // Salva hist√≥rico atualizado
      this.conversations.set(userId, conversation);

      return response;
    } catch (error) {
      console.error('Erro ao gerar resposta:', error);
      return 'Desculpe, ocorreu um erro ao processar sua mensagem. Tente novamente.';
    }
  }

  // Limpar hist√≥rico de um usu√°rio
  clearHistory(userId) {
    this.conversations.delete(userId);
    return 'Hist√≥rico da conversa limpo! üßπ';
  }

  // Obter estat√≠sticas
  getStats() {
    return {
      activeConversations: this.conversations.size,
      totalMessages: Array.from(this.conversations.values())
        .reduce((total, conv) => total + conv.length, 0)
    };
  }
}

module.exports = GeminiService;
```

## üì± Passo 5: Criar Bot Principal

### src/bot.js
```javascript
const { Client, LocalAuth } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
const GeminiService = require('./gemini');
const { getPromptByKeyword, commands } = require('./prompts');

class WhatsAppBot {
  constructor() {
    this.client = new Client({
      authStrategy: new LocalAuth(),
      puppeteer: {
        headless: true,
        args: ['--no-sandbox', '--disable-setuid-sandbox']
      }
    });
    
    this.gemini = new GeminiService();
    this.userPrompts = new Map(); // Prompts personalizados por usu√°rio
    this.setupEventListeners();
  }

  setupEventListeners() {
    // QR Code para autentica√ß√£o
    this.client.on('qr', (qr) => {
      console.log('üì± Escaneie o QR Code com seu WhatsApp:');
      qrcode.generate(qr, { small: true });
    });

    // Bot pronto
    this.client.on('ready', () => {
      console.log('‚úÖ Bot est√° pronto e funcionando!');
      console.log('ü§ñ GeminiBot conectado ao WhatsApp');
    });

    // Processar mensagens
    this.client.on('message', async (message) => {
      await this.handleMessage(message);
    });

    // Erros
    this.client.on('auth_failure', () => {
      console.error('‚ùå Falha na autentica√ß√£o');
    });

    this.client.on('disconnected', (reason) => {
      console.log('üì± Bot desconectado:', reason);
    });
  }

  async handleMessage(message) {
    // Ignora mensagens de status e grupos (opcional)
    if (message.isStatus || message.from.includes('@g.us')) {
      return;
    }

    const userId = message.from;
    const messageBody = message.body.trim();

    try {
      // Comandos especiais
      if (messageBody.startsWith('/')) {
        await this.handleCommand(message, messageBody);
        return;
      }

      // Determinar prompt personalizado
      let customPrompt = this.userPrompts.get(userId) || getPromptByKeyword(messageBody);

      // Gerar resposta
      const response = await this.gemini.generateResponse(userId, messageBody, customPrompt);

      // Simular digita√ß√£o (opcional)
      await this.client.sendSeen(userId);
      await new Promise(resolve => setTimeout(resolve, 1000));

      // Enviar resposta
      await message.reply(response);

    } catch (error) {
      console.error('Erro ao processar mensagem:', error);
      await message.reply('‚ùå Ocorreu um erro. Tente novamente em alguns segundos.');
    }
  }

  async handleCommand(message, command) {
    const userId = message.from;

    switch (command) {
      case '/help':
        await message.reply(this.getHelpMessage());
        break;

      case '/clear':
        const clearMsg = this.gemini.clearHistory(userId);
        this.userPrompts.delete(userId);
        await message.reply(clearMsg);
        break;

      case '/stats':
        const stats = this.gemini.getStats();
        await message.reply(`üìä *Estat√≠sticas do Bot:*\n\n‚Ä¢ Conversas ativas: ${stats.activeConversations}\n‚Ä¢ Mensagens processadas: ${stats.totalMessages}`);
        break;

      case '/prompt_tecnico':
      case '/prompt_educacional':
      case '/prompt_vendas':
      case '/prompt_criativo':
      case '/prompt_padrao':
        this.userPrompts.set(userId, commands[command]);
        await message.reply(`‚úÖ Prompt alterado para: *${command.replace('/prompt_', '').replace('_', ' ')}*`);
        break;

      default:
        if (command.startsWith('/prompt_custom ')) {
          const customPrompt = command.replace('/prompt_custom ', '');
          this.userPrompts.set(userId, customPrompt);
          await message.reply('‚úÖ Prompt personalizado definido!');
        } else {
          await message.reply('‚ùì Comando n√£o reconhecido. Use /help para ver comandos dispon√≠veis.');
        }
    }
  }

  getHelpMessage() {
    return `ü§ñ *GeminiBot - Comandos Dispon√≠veis:*

*Comandos B√°sicos:*
‚Ä¢ /help - Mostra esta ajuda
‚Ä¢ /clear - Limpa hist√≥rico da conversa
‚Ä¢ /stats - Mostra estat√≠sticas do bot

*Prompts Especializados:*
‚Ä¢ /prompt_tecnico - Modo suporte t√©cnico
‚Ä¢ /prompt_educacional - Modo educacional
‚Ä¢ /prompt_vendas - Modo vendas
‚Ä¢ /prompt_criativo - Modo criativo
‚Ä¢ /prompt_padrao - Volta ao modo padr√£o

*Prompt Personalizado:*
‚Ä¢ /prompt_custom [seu prompt] - Define prompt personalizado

*Exemplo:*
/prompt_custom Voc√™ √© um chef especializado em culin√°ria brasileira

‚ú® *Dica:* O bot detecta automaticamente o contexto e ajusta suas respostas!`;
  }

  async start() {
    console.log('üöÄ Iniciando WhatsApp Bot com Gemini AI...');
    await this.client.initialize();
  }
}

module.exports = WhatsAppBot;
```

## ‚ñ∂Ô∏è Passo 6: Arquivo Principal de Execu√ß√£o

### index.js (na raiz do projeto)
```javascript
const WhatsAppBot = require('./src/bot');

// Tratamento de erros n√£o capturados
process.on('unhandledRejection', (reason, promise) => {
  console.error('Erro n√£o tratado:', reason);
});

process.on('uncaughtException', (error) => {
  console.error('Exce√ß√£o n√£o capturada:', error);
  process.exit(1);
});

// Inicializar bot
async function main() {
  try {
    const bot = new WhatsAppBot();
    await bot.start();
  } catch (error) {
    console.error('Erro ao inicializar o bot:', error);
    process.exit(1);
  }
}

main();
```

## üìù Passo 7: Configurar package.json

### Adicionar scripts no package.json:
```json
{
  "name": "whatsapp-gemini-bot",
  "version": "1.0.0",
  "description": "Bot WhatsApp com Gemini AI",
  "main": "index.js",
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js"
  },
  "dependencies": {
    "whatsapp-web.js": "^1.23.0",
    "@google/generative-ai": "^0.2.1",
    "qrcode-terminal": "^0.12.0",
    "dotenv": "^16.3.1"
  },
  "devDependencies": {
    "nodemon": "^3.0.2"
  }
}
```

## üöÄ Passo 8: Executar o Bot

### 8.1 - Instalar depend√™ncia de desenvolvimento (opcional)
```bash
npm install -D nodemon
```

### 8.2 - Executar o bot
```bash
npm start
```

### 8.3 - Para modo desenvolvimento
```bash
npm run dev
```

## üìã Passo 9: Como Usar

### 9.1 - Primeira execu√ß√£o:
1. Execute o comando `npm start`
2. Escaneie o QR Code com seu WhatsApp
3. O bot estar√° pronto para uso!

### Erros
O aviso que voc√™ est√° vendo n√£o √© exatamente um erro, mas sim avisos de seguran√ßa que devem ser tratados. Aqui est√° como resolver:
1. Execute o audit fix primeiro
bashnpm audit fix
Se isso n√£o resolver todas as vulnerabilidades, tente:
bashnpm audit fix --force
2. Atualize o puppeteer (se necess√°rio)
O aviso sobre puppeteer deprecated pode ser resolvido atualizando para uma vers√£o mais recente:
bashnpm install puppeteer@latest
3. Verifique se tudo est√° funcionando
Depois das corre√ß√µes, verifique novamente:
bashnpm audit
4. Se ainda houver problemas, reinstale tudo
Se os problemas persistirem, voc√™ pode limpar e reinstalar:
bash# Remove node_modules e package-lock.json
rmdir /s node_modules
del package-lock.json

# Reinstala tudo
npm install
5. Para projetos novos, use vers√µes espec√≠ficas
Se voc√™ est√° come√ßando um projeto novo, pode especificar vers√µes mais recentes:
bashnpm install whatsapp-web.js@latest @google/generative-ai@latest qrcode-terminal@latest dotenv@latest
Dica importante
Os avisos de vulnerabilidade s√£o comuns em depend√™ncias de terceiros. O npm audit fix geralmente resolve a maioria deles automaticamente. Se algumas vulnerabilidades permanecerem, verifique se s√£o realmente cr√≠ticas para seu caso de uso espec√≠fico.
O seu projeto deve funcionar normalmente mesmo com esses avisos, mas √© uma boa pr√°tica mant√™-los resolvidos por quest√µes de seguran√ßa.
### 9.2 - Comandos dispon√≠veis:
- `/help` - Mostra ajuda
- `/clear` - Limpa hist√≥rico
- `/stats` - Estat√≠sticas
- `/prompt_tecnico` - Modo t√©cnico
- `/prompt_educacional` - Modo educacional
- `/prompt_vendas` - Modo vendas
- `/prompt_criativo` - Modo criativo
- `/prompt_custom [texto]` - Prompt personalizado

### 9.3 - Exemplos de uso:
```
Usu√°rio: "Preciso de ajuda t√©cnica com meu computador"
Bot: [Responde no modo t√©cnico]

Usu√°rio: "/prompt_custom Voc√™ √© um especialista em marketing digital"
Bot: "‚úÖ Prompt personalizado definido!"

Usu√°rio: "Como fazer uma campanha no Instagram?"
Bot: [Responde como especialista em marketing]
```

## üîß Funcionalidades Implementadas

### ‚úÖ Recursos Principais:
- ‚úÖ Integra√ß√£o completa WhatsApp + Gemini
- ‚úÖ QR Code para autentica√ß√£o
- ‚úÖ Prompts personalizados e adaptativos
- ‚úÖ Hist√≥rico de conversas por usu√°rio
- ‚úÖ Comandos administrativos
- ‚úÖ Detec√ß√£o autom√°tica de contexto
- ‚úÖ Controle de limite de tokens
- ‚úÖ Tratamento de erros robusto

### ‚ö° Recursos Avan√ßados:
- ü§ñ 5 prompts pr√©-configurados
- üíæ Persist√™ncia de sess√£o WhatsApp
- üìä Sistema de estat√≠sticas
- üßπ Limpeza de hist√≥rico
- üéØ Prompts adaptativos por palavra-chave
- ‚öôÔ∏è Configura√ß√£o flex√≠vel via .env

## üîí Seguran√ßa e Boas Pr√°ticas

### Vari√°veis de ambiente:
```env
# .env
GEMINI_API_KEY=sua_chave_api_aqui
MAX_TOKENS=1000
TEMPERATURE=0.7
```

### Limites implementados:
- Hist√≥rico limitado a 10 mensagens por usu√°rio
- M√°ximo de 1000 tokens por resposta
- Timeout de requisi√ß√µes
- Tratamento de erros da API

## üöÄ Deploy e Produ√ß√£o

### Para deploy em servidor:
```bash
# Instalar PM2 para gerenciamento
npm install -g pm2

# Criar arquivo ecosystem
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'whatsapp-gemini-bot',
    script: 'index.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production'
    }
  }]
}
EOF

# Iniciar com PM2
pm2 start ecosystem.config.js
```

## üÜò Solu√ß√£o de Problemas

### Problemas comuns:
1. **QR Code n√£o aparece**: Verifique se o terminal suporta caracteres especiais
2. **Erro de API**: Verifique se a chave do Gemini est√° correta no .env
3. **Bot n√£o responde**: Verifique os logs de erro no console
4. **Sess√£o perdida**: Delete a pasta `.wwebjs_auth` e reinicie

### Logs √∫teis:
```javascript
// Adicionar logs detalhados
console.log('Mensagem recebida de:', message.from);
console.log('Conte√∫do:', message.body);
```

## üìö Pr√≥ximos Passos

### Melhorias poss√≠veis:
- üîÑ Integra√ß√£o com banco de dados
- üìé Suporte a imagens e documentos
- üîî Sistema de notifica√ß√µes
- üìà Analytics avan√ßados
- üåê Interface web de gerenciamento
- üîê Sistema de autentica√ß√£o de usu√°rios
- üìã Comandos administrativos avan√ßados

Este bot est√° pronto para uso e pode ser facilmente expandido conforme suas necessidades!
